#!/bin/bash

# This fetches and checks-out a gerrit review branch
# There are 2 froms:
#
# Form 1 (1 argument)
# $ git checkout-review change-num/patchset
# Checks out the specified review in a detached HEAD state
# $ git checkout-review 176/1
#
# Form 2 (2 arguments)
# $ git checkout-review change-num/patchset <branch-name>
# Checks out the specified review in a locally created branch named <branch-name>
# $ git checkout-review 176/1 bug/essms-123-terse-name
#

remote_name=`git remote`
full_change_id=$1
change_id=$(echo $full_change_id | cut -f 1 -d "/")
patchset=$(echo $full_change_id | cut -f 2 -d "/")
change_dir=${change_id:(-2)}
if [ ${#change_dir} -lt 2 ]; then
  change_dir=${change_id:(-1)}
  change_dir="0${change_dir}"
fi

if [ "$2" != "" ]; then
  git fetch $remote_name refs/changes/$change_dir/$change_id/$patchset:$2 && git checkout $2
elif [ "$1" != "" ]; then
  git fetch $remote_name refs/changes/$change_dir/$change_id/$patchset && git checkout FETCH_HEAD
else
  echo "Missing arguments:"
  echo "Usage: git checkout-review #/# [new-local-branch-name]"
  exit 1
fi
